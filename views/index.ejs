<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="background-layer"></div>

    <div class="container">
        <header class="main-header">
            <div class="title-section">
                <h1>ABSENSI SISWA KELAS 6</h1>
                <p id="current-date">Tanggal akan diupdate oleh JS</p>
            </div>
            <div class="registration-controls">
                <span>Mode Registrasi: <b id="reg-status">OFF</b></span>
                <button id="toggle-reg-mode" class="btn btn-secondary">Aktifkan</button>
            </div>
            <div class="user-info">
            <span>Selamat datang, <strong><%= user.username %></strong>!</span>
            <button id="logout-button" class="btn btn-logout">Logout</button>
        </div>
        </header>

        <div class="content-wrapper">
            <main class="attendance-main">
                <h2>Kehadiran Hari Ini</h2>
                <div class="table-container">
                    <table id="attendance-table">
                        <thead>
                            <tr>
                                <th>NO</th>
                                <th>NAMA</th>
                                <th>NIS</th>
                                <th>WAKTU</th>
                                <th>STATUS</th>
                                <th>FOTO</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (attendances.length > 0) { %>
                                <% attendances.forEach((att, index) => { %>
                                    <tr id="att-<%= att._id %>">
                                        <td><%= index + 1 %></td>
                                        <td><%= att.student ? att.student.name : 'Siswa Dihapus' %></td>
                                        <td><%= att.student ? att.student.studentId : '-' %></td>
                                        <td><%= att.status === 'HADIR' ? new Date(att.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-' %></td>
                                        <td><span class="status-badge status-<%= att.status.toLowerCase() %>"><%= att.status %></span></td>
                                        <td>
                                            <div class="photo-cell">
                                            <% if (att.photoUrl && att.photoUrl !== '/photos/default.png') { %>
                                                <img src="<%= att.photoUrl %>" alt="Foto Absensi">
                                            <% } else { %>
                                                <img src="/photos/default-avatar.png" alt="Avatar Default">
                                            <% } %>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr id="no-data"><td colspan="6">Belum ada data absensi hari ini.</td></tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </main>
            
            <aside class="manual-attendance-section">
                <h2>Absensi Manual</h2>
                <p>Siswa yang belum tercatat kehadirannya hari ini.</p>
                <ul id="absent-student-list">
                    <% if (absentStudents.length > 0) { %>
                        <% absentStudents.forEach(student => { %>
                            <li class="absent-student-item" id="absent-<%= student._id %>">
                                <div class="student-info">
                                    <span><%= student.name %></span>
                                    <small><%= student.studentId %></small>
                                </div>
                                <div class="status-buttons">
                                    <select>
                                        <option value="">-- Status --</option>
                                        <option value="IZIN">Izin</option>
                                        <option value="SAKIT">Sakit</option>
                                        <option value="ALFA">Alfa</option>
                                    </select>
                                    <button class="btn-save-manual" data-studentid="<%= student._id %>">Simpan</button>
                                </div>
                            </li>
                        <% }) %>
                    <% } else { %>
                        <li class="all-present">Semua siswa sudah tercatat kehadirannya!</li>
                    <% } %>
                </ul>
            </aside>
        </div>

        <footer class="actions-footer">
            <a href="/register" class="btn btn-footer">Kelola Siswa</a>
            <a href="/reports" class="btn btn-footer">Laporan</a>
            <button id="export-button" class="btn btn-export">Export Hari Ini</button>
        </footer>
    </div>

    <div id="registration-modal" class="modal-overlay"> 
        <div class="modal-content">
            <h2>Registrasi Kartu Baru</h2>
            <p>Tap kartu baru terdeteksi! Silakan lengkapi data di bawah ini.</p>
            <form id="registration-form">
                <div class="form-group">
                    <label for="reg-uid">UID Kartu:</label>
                    <input type="text" id="reg-uid" name="uid" readonly>
                </div>
                <div class="form-group">
                    <label for="reg-name">Nama Siswa:</label>
                    <input type="text" id="reg-name" name="name" required placeholder="Masukkan nama lengkap...">
                </div>
                <div class="form-group">
                    <label for="reg-student-id">ID Siswa (NISN):</label>
                    <input type="text" id="reg-student-id" name="studentId" required placeholder="Masukkan ID siswa...">
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancel-reg-button" class="btn btn-footer">Batal</button>
                    <button type="submit" class="btn btn-export">Simpan Pendaftaran</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/js/dashboard.js"></script>
</body>
</html>